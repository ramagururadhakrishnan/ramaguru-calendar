<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ramaguru's Event Calendar</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Arial;margin:0;padding:0;background:#fff;color:#111}
.header{background:#f5f5f5;padding:12px 16px;display:flex;gap:12px;align-items:center}
#calendar,#tableView{max-width:1100px;margin:18px auto;padding:8px}
#tableView{display:none}
.btn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
.btn.primary{background:#0066cc;color:#fff;border-color:#0066cc}
.search{padding:6px;border:1px solid #ccc;border-radius:4px}
.legend-swatch{width:14px;height:14px;border-radius:3px;border:1px solid #ccc}
</style>
</head>

<body>
<div class="header">
  <h1>Ramaguru Radhakrishnan's Event Calendar</h1>
  <div class="controls">
    <label>Year</label>
    <select id="yearSelect" class="btn small"></select>
    <button id="toggleView" class="btn">Switch to Table</button>
    <button id="downloadIcs" class="btn">Download ICS</button>
    <button id="downloadMermaid" class="btn">Download Gantt</button>
    <button id="openAdd" class="btn primary">Add Event</button>
  </div>
</div>

<div style="max-width:1100px;margin:12px auto;">
  <input id="searchBox" class="search" placeholder="Search">
  <select id="categoryFilter" class="btn small"><option value="">All Categories</option></select>
  <select id="organizerFilter" class="btn small"><option value="">All Organizers</option></select>
  <div id="legend" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"></div>
</div>

<div id="calendar"></div>
<div id="tableView"><div id="tableContent"></div></div>

<div id="addForm" style="display:none;max-width:1100px;margin:12px auto;border:1px solid #ccc;padding:10px;">
  <input id="ev_name" placeholder="Event Name">
  <input id="ev_date" placeholder="Date YYYY-MM-DD">
  <input id="ev_time" placeholder="Time HH:MM">
  <input id="ev_category" placeholder="Category">
  <input id="ev_venue" placeholder="Venue">
  <input id="ev_organizer" placeholder="Organizer">
  <input id="ev_stakeholders" placeholder="Stakeholders">
  <input id="ev_status" placeholder="Status">

  <!-- missing fields added -->
  <input id="ev_deliverables" placeholder="Deliverables">
  <input id="ev_promo" placeholder="Promotion Plan">
  <input id="ev_budget" placeholder="Budget/Support">

  <textarea id="ev_notes" placeholder="Notes"></textarea><br>
  <input id="gh_token" placeholder="GitHub Token (optional)" style="width:60%">
  <button id="saveLocal" class="btn">Add Locally</button>
  <button id="saveGit" class="btn primary">Commit to GitHub</button>
  <button id="closeAdd" class="btn">Close</button>
</div>

<script>
const config = {
  github_user:"ramagururadhakrishnan",
  github_repo:"ramaguru-calendar",
  branch:"main",
  csv_paths:["data/2025-events.csv","data/2026-events.csv"],
  default_year:"2025"
};

let allEvents=[],calendar=null,categoryColors={};
const defaultColors=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f"];

function rawCsvUrl(p){return `https://raw.githubusercontent.com/${config.github_user}/${config.github_repo}/${config.branch}/${p}`;}

async function loadCsv(path){
  const r=await fetch(rawCsvUrl(path));
  const t=await r.text();
  return Papa.parse(t,{header:true,skipEmptyLines:true}).data;
}

function buildColor(cat){
  if(!categoryColors[cat]) categoryColors[cat]=defaultColors[Object.keys(categoryColors).length%defaultColors.length];
  return categoryColors[cat];
}

function legend(){const L=document.getElementById("legend");L.innerHTML="";Object.keys(categoryColors).forEach(c=>L.innerHTML+=`<div><span class="legend-swatch" style="background:${categoryColors[c]}"></span> ${c}</div>`);}

function table(ev){
  let h="<table border=1 style='width:100%;border-collapse:collapse'><tr><th>Date</th><th>Name</th><th>Category</th><th>Organizer</th><th>Status</th></tr>";
  ev.forEach(e=>{const p=e.extendedProps;h+=`<tr><td>${p.Date}</td><td>${p["Event Name"]}</td><td>${p.Category}</td><td>${p.Organizer}</td><td>${p.Status}</td></tr>`});
  h+="</table>";document.getElementById("tableContent").innerHTML=h;
}

function filter(){
  const s=document.getElementById("searchBox").value.toLowerCase();
  const c=document.getElementById("categoryFilter").value;
  const o=document.getElementById("organizerFilter").value;
  return allEvents.filter(e=>{
    const p=e.extendedProps;
    return (!c||p.Category===c)&&(!o||p.Organizer===o) && (e.title+" "+JSON.stringify(p)).toLowerCase().includes(s);
  });
}

function refresh(){
  const f=filter();
  calendar.removeAllEvents();f.forEach(e=>calendar.addEvent(e));
  table(f);
}

function readForm(){
  const p={},ids=["Event Name","Date","Time","Category","Venue","Organizer","Stakeholders","Deliverables","Promotion Plan","Budget/Support Required","Status","Notes"];
  const map={"Event Name":"ev_name","Date":"ev_date","Time":"ev_time","Category":"ev_category","Venue":"ev_venue","Organizer":"ev_organizer","Stakeholders":"ev_stakeholders","Deliverables":"ev_deliverables","Promotion Plan":"ev_promo","Budget/Support Required":"ev_budget","Status":"ev_status","Notes":"ev_notes"};
  ids.forEach(k=>p[k]=document.getElementById(map[k]).value);
  return {title:p["Event Name"],start:p.Date,extendedProps:p,color:buildColor(p.Category)};
}

/* ICS + Mermaid stubs */
function eventsToIcs(ev){
  let t="BEGIN:VCALENDAR\nVERSION:2.0\n";
  ev.forEach(e=>{t+=`BEGIN:VEVENT\nSUMMARY:${e.title}\nDTSTART:${e.start.replace(/-/g,"")}T000000\nEND:VEVENT\n`;});
  return t+"END:VCALENDAR";
}
function buildMermaidGantt(ev){
  let t="```mermaid\ngantt\ndateFormat YYYY-MM-DD\n";
  ev.forEach(e=>t+=`"${e.title}" : ${e.extendedProps.Date}, 1d\n`);
  return t+"```\n";
}

/* Init */
window.onload=async()=>{
  const sel=document.getElementById("yearSelect");
  config.csv_paths.forEach(p=>{
    const y=p.match(/\d{4}/)[0];
    sel.innerHTML+=`<option value="${p}">${y}</option>`;
  });
  sel.value=config.csv_paths.find(p=>p.includes(config.default_year));

  async function loadYear(){
    const data=await loadCsv(sel.value);
    allEvents=data.filter(r=>r.Date&&r["Event Name"]).map(r=>({title:r["Event Name"],start:r.Date,extendedProps:r,color:buildColor(r.Category)}));
    legend();
    refresh();
  }

  calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{initialView:"dayGridMonth"});
  calendar.render();

  document.getElementById("toggleView").onclick=()=>{
    const c=document.getElementById("calendar"),t=document.getElementById("tableView");
    if(c.style.display==="none"){c.style.display="";t.style.display="none";}else{c.style.display="none";t.style.display="";}
  };

  ["searchBox","categoryFilter","organizerFilter"].forEach(id=>document.getElementById(id).oninput=refresh);
  document.getElementById("openAdd").onclick=()=>document.getElementById("addForm").style.display="";
  document.getElementById("closeAdd").onclick=()=>document.getElementById("addForm").style.display="none";
  document.getElementById("saveLocal").onclick=()=>{allEvents.push(readForm());refresh();};

  document.getElementById("downloadIcs").onclick=()=>download("events.ics",eventsToIcs(filter()));
  document.getElementById("downloadMermaid").onclick=()=>download("gantt.md",buildMermaidGantt(filter()));

  await loadYear();
  sel.onchange=loadYear;
};

function download(n,t){const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([t]));a.download=n;a.click();}
</script>
</body>
</html>
